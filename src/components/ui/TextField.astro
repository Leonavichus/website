---
// src/components/ui/TextField.astro
/**
 * Material Design 3 Text Field Component
 * –ì–õ–£–ë–û–ö–ò–ô FIX: –°–¢–†–û–ì–û –û–î–ò–ù —ç–ª–µ–º–µ–Ω—Ç —Å–ø—Ä–∞–≤–∞!
 */

export interface Props {
  label: string;
  type?: 'text' | 'password' | 'email' | 'search' | 'tel' | 'url' | 'number';
  variant?: 'filled' | 'outlined';
  name?: string;
  value?: string;
  placeholder?: string;
  disabled?: boolean;
  readonly?: boolean;
  required?: boolean;
  error?: boolean;
  helperText?: string;
  leadingIcon?: string;
  trailingIcon?: string;
  class?: string;
}

const {
  label,
  type = 'text',
  variant = 'filled',
  name,
  value,
  placeholder,
  disabled = false,
  readonly = false,
  required = false,
  error = false,
  helperText,
  leadingIcon,
  trailingIcon,
  class: className = '',
} = Astro.props;

import Icon from './Icon.astro';

const inputId = `textfield-${Math.random().toString(36).substr(2, 9)}`;

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¢–ò–ü trailing —ç–ª–µ–º–µ–Ω—Ç–∞ (–°–¢–†–û–ì–û –û–î–ò–ù!)
let trailingType: 'password' | 'search' | 'icon' | 'none' = 'none';

if (type === 'password') {
  trailingType = 'password';
} else if (type === 'search') {
  trailingType = 'search';
} else if (trailingIcon) {
  trailingType = 'icon';
}

const hasTrailingElement = trailingType !== 'none';
---

<div
  class:list={[
    'textfield',
    `textfield-${variant}`,
    { 'textfield-disabled': disabled },
    { 'textfield-error': error },
    { 'textfield-with-leading-icon': leadingIcon },
    { 'textfield-with-trailing-icon': hasTrailingElement },
    className,
  ]}
>
  {leadingIcon && (
    <span class="textfield-icon textfield-icon-leading">
      <Icon name={leadingIcon} />
    </span>
  )}

  <div class="textfield-input-wrapper">
    <input
      type={type}
      id={inputId}
      name={name}
      value={value}
      placeholder={placeholder || ' '}
      disabled={disabled}
      readonly={readonly}
      required={required}
      class="textfield-input"
      autocomplete={type === 'search' ? 'off' : undefined}
    />

    <label for={inputId} class="textfield-label">
      {label}{required && ' *'}
    </label>
  </div>

  {/* 
    –ö–†–ò–¢–ò–ß–ù–û: –†–µ–Ω–¥–µ—Ä–∏–º –°–¢–†–û–ì–û –û–î–ò–ù —ç–ª–µ–º–µ–Ω—Ç!
    –ò—Å–ø–æ–ª—å–∑—É–µ–º if-else —Ü–µ–ø–æ—á–∫—É, –∞ –Ω–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
  */}
  {trailingType === 'password' ? (
    <!-- Password: –¢–û–õ–¨–ö–û visibility toggle -->
    <button
      type="button"
      class="textfield-icon-button"
      aria-label="Toggle password visibility"
      data-password-toggle
    >
      <Icon name="visibility" />
    </button>
  ) : trailingType === 'search' ? (
    <!-- Search: –¢–û–õ–¨–ö–û clear button -->
    <button
      type="button"
      class="textfield-icon-button textfield-clear-button"
      aria-label="Clear search"
      data-search-clear
    >
      <Icon name="close" />
    </button>
  ) : trailingType === 'icon' ? (
    <!-- Other: –¢–û–õ–¨–ö–û static icon -->
    <span class="textfield-icon textfield-icon-trailing">
      <Icon name={trailingIcon!} />
    </span>
  ) : null}

  {helperText && (
    <span class="textfield-helper-text">{helperText}</span>
  )}
</div>

<style>
  .textfield {
    position: relative;
    display: inline-flex;
    align-items: center;
    width: 100%;
    max-width: 400px;
  }

  .textfield-input-wrapper {
    position: relative;
    flex: 1;
    display: flex;
    align-items: center;
  }

  /* Input */
  .textfield-input {
    width: 100%;
    height: 56px;
    padding: 20px 16px 8px;
    border: none;
    background: transparent;
    font-family: var(--md-sys-typescale-body-large-font);
    font-size: var(--md-sys-typescale-body-large-size);
    color: var(--md-sys-color-on-surface);
    outline: none;
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    z-index: 1;
  }

  /* –û—Ç–∫–ª—é—á–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è search */
  .textfield-input[type="search"]::-webkit-search-decoration,
  .textfield-input[type="search"]::-webkit-search-cancel-button,
  .textfield-input[type="search"]::-webkit-search-results-button,
  .textfield-input[type="search"]::-webkit-search-results-decoration {
    -webkit-appearance: none;
    display: none;
  }

  /* –û—Ç–∫–ª—é—á–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è password */
  .textfield-input[type="password"]::-ms-reveal,
  .textfield-input[type="password"]::-ms-clear {
    display: none;
  }

  .textfield-with-leading-icon .textfield-input {
    padding-left: 52px;
  }

  .textfield-with-trailing-icon .textfield-input {
    padding-right: 52px;
  }

  /* Label */
  .textfield-label {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    font-family: var(--md-sys-typescale-body-large-font);
    font-size: var(--md-sys-typescale-body-large-size);
    color: var(--md-sys-color-on-surface-variant);
    pointer-events: none;
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 2;
  }

  .textfield-with-leading-icon .textfield-label {
    left: 52px;
  }

  .textfield-input:focus ~ .textfield-label,
  .textfield-input:not(:placeholder-shown) ~ .textfield-label {
    top: 8px;
    font-size: 12px;
    transform: translateY(0);
  }

  .textfield-input:focus ~ .textfield-label {
    color: var(--md-sys-color-primary);
  }

  /* Filled variant */
  .textfield-filled .textfield-input-wrapper {
    background-color: var(--md-sys-color-surface-container-highest);
    border-radius: 4px 4px 0 0;
    border-bottom: 1px solid var(--md-sys-color-on-surface-variant);
  }

  .textfield-filled .textfield-input-wrapper::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: var(--md-sys-color-primary);
    transform: scaleX(0);
    transition: transform 200ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  .textfield-filled:has(.textfield-input:focus) .textfield-input-wrapper::after {
    transform: scaleX(1);
  }

  /* Outlined variant */
  .textfield-outlined .textfield-input-wrapper {
    border: 1px solid var(--md-sys-color-outline);
    border-radius: 4px;
  }

  .textfield-outlined:has(.textfield-input:focus) .textfield-input-wrapper {
    border-color: var(--md-sys-color-primary);
    border-width: 2px;
  }

  /* Icons */
  .textfield-icon {
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    color: var(--md-sys-color-on-surface-variant);
    z-index: 3;
    pointer-events: none;
  }

  .textfield-icon-leading {
    left: 4px;
  }

  .textfield-icon-trailing {
    right: 4px;
  }

  /* Icon button */
  .textfield-icon-button {
    position: absolute;
    right: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    padding: 0;
    border: none;
    border-radius: 50%;
    background: transparent;
    color: var(--md-sys-color-on-surface-variant);
    cursor: pointer;
    transition: background-color 200ms cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 3;
  }

  .textfield-icon-button:hover {
    background-color: rgba(0, 0, 0, 0.08);
  }

  /* Search clear button - –°–ö–†–´–¢ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  .textfield-clear-button {
    display: none;
  }

  .textfield-clear-button.visible {
    display: flex;
  }

  /* Helper text */
  .textfield-helper-text {
    position: absolute;
    bottom: -20px;
    left: 16px;
    font-family: var(--md-sys-typescale-body-small-font);
    font-size: var(--md-sys-typescale-body-small-size);
    color: var(--md-sys-color-on-surface-variant);
  }

  /* Error state */
  .textfield-error .textfield-input-wrapper {
    border-color: var(--md-sys-color-error);
  }

  .textfield-error .textfield-label {
    color: var(--md-sys-color-error);
  }

  .textfield-error .textfield-helper-text {
    color: var(--md-sys-color-error);
  }

  /* Disabled */
  .textfield-disabled {
    opacity: 0.38;
    pointer-events: none;
  }

  /* Placeholder */
  .textfield-input::placeholder {
    color: transparent;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üîç TextField script initialized');

    // Password toggle
    const passwordToggles = document.querySelectorAll('[data-password-toggle]');
    console.log('üëÅ Password toggles found:', passwordToggles.length);

    passwordToggles.forEach((button) => {
      button.addEventListener('click', () => {
        const wrapper = button.parentElement;
        const input = wrapper?.querySelector('input') as HTMLInputElement;
        const icon = button.querySelector('.icon') as HTMLElement;

        if (input && icon) {
          if (input.type === 'password') {
            input.type = 'text';
            icon.textContent = 'visibility_off';
          } else {
            input.type = 'password';
            icon.textContent = 'visibility';
          }
        }
      });
    });

    // Search clear
    const searchInputs = document.querySelectorAll('input[type="search"]');
    console.log('üîç Search inputs found:', searchInputs.length);

    searchInputs.forEach((input) => {
      const wrapper = input.parentElement?.parentElement;
      const clearButton = wrapper?.querySelector('[data-search-clear]') as HTMLElement;

      if (clearButton) {
        console.log('‚úÖ Clear button found for search input');

        const toggleClearButton = () => {
          const inputElement = input as HTMLInputElement;
          if (inputElement.value) {
            clearButton.classList.add('visible');
          } else {
            clearButton.classList.remove('visible');
          }
        };

        // Initial state
        toggleClearButton();

        // Listen for input changes
        input.addEventListener('input', toggleClearButton);

        // Clear button click
        clearButton.addEventListener('click', () => {
          const inputElement = input as HTMLInputElement;
          inputElement.value = '';
          clearButton.classList.remove('visible');
          inputElement.focus();
        });
      } else {
        console.warn('‚ö†Ô∏è Clear button NOT found for search input');
      }
    });
  });
</script>
