---
// src/components/ui/ImageGallery.astro
/**
 * Material Design 3 Image Gallery Component
 */

export interface Props {
  images: Array<{
    src: string;
    thumb?: string;
    alt: string;
  }>;
  columns?: 2 | 3 | 4;
  aspectRatio?: '1:1' | '4:3' | '3:2';
  showMainImage?: boolean;
  class?: string;
}

const {
  images,
  columns = 4,
  aspectRatio = '1:1',
  showMainImage = true,
  class: className,
} = Astro.props;

const galleryId = `gallery-${Math.random().toString(36).substr(2, 9)}`;

const aspectRatioMap = {
  '1:1': '100%',
  '4:3': '75%',
  '3:2': '66.67%',
};
---

<div class:list={['image-gallery', className]} id={galleryId}>
  {showMainImage && (
    <div class="gallery-main">
      <img
        src={images[0]?.src}
        alt={images[0]?.alt}
        class="gallery-main-image"
        id={`${galleryId}-main`}
        loading="lazy"
      />
    </div>
  )}

  <div class:list={['gallery-grid', `gallery-cols-${columns}`]}>
    {images.map((image, index) => (
      <button
        class="gallery-item"
        data-index={index}
        data-src={image.src}
        data-alt={image.alt}
        type="button"
        aria-label={`View ${image.alt}`}
      >
        <div
          class="gallery-item-wrapper"
          style={`padding-bottom: ${aspectRatioMap[aspectRatio]};`}
        >
          <img
            src={image.thumb || image.src}
            alt={image.alt}
            class="gallery-item-image"
            loading="lazy"
          />
        </div>
      </button>
    ))}
  </div>

  <!-- Lightbox -->
  <div class="gallery-lightbox" id={`${galleryId}-lightbox`}>
    <div class="lightbox-overlay"></div>

    <button class="lightbox-close" aria-label="Close">
      <span class="material-symbols-outlined">close</span>
    </button>

    <button class="lightbox-prev" aria-label="Previous">
      <span class="material-symbols-outlined">chevron_left</span>
    </button>

    <button class="lightbox-next" aria-label="Next">
      <span class="material-symbols-outlined">chevron_right</span>
    </button>

    <div class="lightbox-content">
      <img src="" alt="" class="lightbox-image" id={`${galleryId}-lightbox-img`} />
    </div>

    <div class="lightbox-counter" id={`${galleryId}-counter`}>
      1 / {images.length}
    </div>
  </div>
</div>

<style>
  .image-gallery {
    width: 100%;
  }

  .gallery-main {
    margin-bottom: 16px;
    border-radius: 12px;
    overflow: hidden;
    background-color: var(--md-sys-color-surface-container);
  }

  .gallery-main-image {
    width: 100%;
    height: auto;
    max-height: 600px;
    object-fit: contain;
    display: block;
    background-color: var(--md-sys-color-surface-container);
  }

  .gallery-grid {
    display: grid;
    gap: 8px;
  }

  .gallery-cols-2 {
    grid-template-columns: repeat(2, 1fr);
  }

  .gallery-cols-3 {
    grid-template-columns: repeat(3, 1fr);
  }

  .gallery-cols-4 {
    grid-template-columns: repeat(4, 1fr);
  }

  .gallery-item {
    position: relative;
    border: none;
    background: transparent;
    padding: 0;
    cursor: pointer;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 200ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  .gallery-item:hover {
    transform: scale(1.05);
  }

  .gallery-item-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    background-color: var(--md-sys-color-surface-container);
  }

  .gallery-item-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Lightbox */
  .gallery-lightbox {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.9);
  }

  .gallery-lightbox.active {
    display: flex;
  }

  .lightbox-overlay {
    position: absolute;
    inset: 0;
  }

  .lightbox-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
  }

  .lightbox-close,
  .lightbox-prev,
  .lightbox-next {
    position: absolute;
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 24px;
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 200ms;
    z-index: 1;
  }

  .lightbox-close:hover,
  .lightbox-prev:hover,
  .lightbox-next:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }

  .lightbox-close {
    top: 16px;
    right: 16px;
  }

  .lightbox-prev {
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
  }

  .lightbox-next {
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
  }

  .lightbox-counter {
    position: absolute;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 16px;
    border-radius: 16px;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 14px;
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .gallery-cols-4 {
      grid-template-columns: repeat(2, 1fr);
    }

    .gallery-cols-3 {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<script>
  document.querySelectorAll('.image-gallery').forEach((gallery) => {
    const galleryEl = gallery as HTMLElement;
    const galleryId = galleryEl.id;
    const items = gallery.querySelectorAll('.gallery-item');
    const mainImage = gallery.querySelector('.gallery-main-image') as HTMLImageElement | null;
    const lightbox = gallery.querySelector('.gallery-lightbox') as HTMLElement | null;
    const lightboxImg = gallery.querySelector('.lightbox-image') as HTMLImageElement | null;
    const closeBtn = gallery.querySelector('.lightbox-close');
    const prevBtn = gallery.querySelector('.lightbox-prev');
    const nextBtn = gallery.querySelector('.lightbox-next');
    const counter = gallery.querySelector('.lightbox-counter') as HTMLElement | null;

    let currentIndex = 0;
    const totalImages = items.length;

    // Thumbnail click
    items.forEach((item, index) => {
      item.addEventListener('click', () => {
        const itemEl = item as HTMLElement;
        const src = itemEl.dataset.src;
        const alt = itemEl.dataset.alt;

        // Update main image
        if (mainImage && src && alt) {
          mainImage.src = src;
          mainImage.alt = alt;
        }

        // Open lightbox
        currentIndex = index;
        if (src && alt) {
          openLightbox(src, alt);
        }
      });
    });

    function openLightbox(src: string, alt: string) {
      if (lightboxImg && lightbox && counter) {
        lightboxImg.src = src;
        lightboxImg.alt = alt;
        lightbox.classList.add('active');
        counter.textContent = `${currentIndex + 1} / ${totalImages}`;
        document.body.style.overflow = 'hidden';
      }
    }

    function closeLightbox() {
      if (lightbox) {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    function showImage(index: number) {
      if (index < 0) index = totalImages - 1;
      if (index >= totalImages) index = 0;

      currentIndex = index;
      const item = items[index] as HTMLElement;
      const src = item.dataset.src;
      const alt = item.dataset.alt;

      if (lightboxImg && counter && src && alt) {
        lightboxImg.src = src;
        lightboxImg.alt = alt;
        counter.textContent = `${currentIndex + 1} / ${totalImages}`;
      }
    }

    // Close button
    closeBtn?.addEventListener('click', closeLightbox);

    // Navigation
    prevBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      showImage(currentIndex - 1);
    });

    nextBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      showImage(currentIndex + 1);
    });

    // Overlay click
    lightbox?.addEventListener('click', (e) => {
      if (
        e.target === lightbox ||
        (e.target as HTMLElement).classList.contains('lightbox-overlay')
      ) {
        closeLightbox();
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!lightbox?.classList.contains('active')) return;

      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showImage(currentIndex - 1);
      if (e.key === 'ArrowRight') showImage(currentIndex + 1);
    });
  });
</script>
