---
// Carousel Component - Material Design 3
// Enhanced transitions
import Icon from './Icon.astro';

export interface Props {
  images: Array<{
    src: string;
    alt: string;
    caption?: string;
  }>;
  autoplay?: boolean;
  interval?: number;
  showIndicators?: boolean;
  showArrows?: boolean;
  aspectRatio?: '16:9' | '4:3' | '1:1' | '3:2' | '21:9';
  transition?: 'fade' | 'slide';
  class?: string;
}

const {
  images,
  autoplay = false,
  interval = 5000,
  showIndicators = true,
  showArrows = true,
  aspectRatio = '16:9',
  transition = 'slide',
  class: className,
} = Astro.props;

const carouselId = `carousel-${Math.random().toString(36).substr(2, 9)}`;

const aspectRatioMap = {
  '16:9': '56.25%',
  '4:3': '75%',
  '1:1': '100%',
  '3:2': '66.67%',
  '21:9': '42.86%',
};
---

<div
  class:list={['carousel', `carousel--${transition}`, className]}
  id={carouselId}
  data-autoplay={autoplay}
  data-interval={interval}
  data-transition={transition}
>
  <div class="carousel-container">
    <div class="carousel-wrapper" style={`padding-bottom: ${aspectRatioMap[aspectRatio]};`}>
      <div class="carousel-track" data-track>
        {
          images.map((image, index) => (
            <div
              class:list={['carousel-slide', { active: index === 0 }]}
              data-index={index}
            >
              <img
                src={image.src}
                alt={image.alt}
                class="carousel-image"
                loading={index === 0 ? 'eager' : 'lazy'}
              />

              {image.caption && (
                <div class="carousel-caption">
                  <div class="carousel-caption-content">{image.caption}</div>
                </div>
              )}

              <div class="carousel-slide-overlay"></div>
            </div>
          ))
        }
      </div>
    </div>

    {showArrows && images.length > 1 && (
      <>
        <button
          class="carousel-arrow carousel-arrow--prev"
          aria-label="Previous"
          data-prev
        >
          <Icon name="chevron_left" />
          <span class="carousel-arrow-ripple"></span>
        </button>

        <button
          class="carousel-arrow carousel-arrow--next"
          aria-label="Next"
          data-next
        >
          <Icon name="chevron_right" />
          <span class="carousel-arrow-ripple"></span>
        </button>
      </>
    )}

    {showIndicators && images.length > 1 && (
      <div class="carousel-indicators">
        {images.map((_, index) => (
          <button
            class:list={['carousel-indicator', { active: index === 0 }]}
            data-index={index}
            aria-label={`Slide ${index + 1}`}
          >
            <span class="carousel-indicator-fill"></span>
          </button>
        ))}
      </div>
    )}

    {images.length > 1 && (
      <div class="carousel-counter">
        <span data-current>1</span>
        <span class="carousel-counter-separator">/</span>
        <span>{images.length}</span>
      </div>
    )}
  </div>
</div>

<style>
  .carousel {
    position: relative;
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
    background: var(--md-sys-color-surface-container);
    box-shadow:
      0 2px 4px rgba(0, 0, 0, 0.08),
      0 4px 8px rgba(0, 0, 0, 0.12);
  }

  .carousel-container {
    position: relative;
  }

  .carousel-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .carousel-track {
    position: relative;
    width: 100%;
    height: 100%;
  }

  /* Slide transitions */
  .carousel-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition:
      opacity 600ms cubic-bezier(0.4, 0, 0.2, 1),
      transform 600ms cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  .carousel--fade .carousel-slide {
    transform: scale(1.05);
  }

  .carousel--slide .carousel-slide {
    transform: translateX(100%);
  }

  .carousel-slide.active {
    opacity: 1;
    transform: translateX(0) scale(1);
    pointer-events: auto;
    z-index: 1;
  }

  .carousel-slide.prev {
    transform: translateX(-100%);
  }

  .carousel-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    user-select: none;
  }

  .carousel-slide-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      transparent 0%,
      transparent 60%,
      rgba(0, 0, 0, 0.3) 100%
    );
    pointer-events: none;
  }

  /* Caption */
  .carousel-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 24px;
    z-index: 2;
  }

  .carousel-caption-content {
    max-width: 600px;
    padding: 16px 20px;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(12px);
    color: white;
    font: var(--md-sys-typescale-body-large);
    line-height: 1.5;
    animation: captionSlideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes captionSlideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Arrows */
  .carousel-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(8px);
    color: var(--md-sys-color-on-surface);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }

  .carousel-arrow:hover {
    background: white;
    transform: translateY(-50%) scale(1.08);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  }

  .carousel-arrow:active {
    transform: translateY(-50%) scale(0.95);
  }

  .carousel-arrow--prev {
    left: 16px;
  }

  .carousel-arrow--next {
    right: 16px;
  }

  .carousel-arrow-ripple {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: var(--md-sys-color-on-surface);
    opacity: 0;
    transform: scale(0);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .carousel-arrow:active .carousel-arrow-ripple {
    opacity: 0.2;
    transform: scale(1);
  }

  /* Indicators */
  .carousel-indicators {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    padding: 20px;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.1), transparent);
  }

  .carousel-indicator {
    position: relative;
    width: 8px;
    height: 8px;
    border: none;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0;
    overflow: hidden;
  }

  .carousel-indicator:hover {
    background: rgba(255, 255, 255, 0.7);
    transform: scale(1.2);
  }

  .carousel-indicator.active {
    width: 32px;
    background: white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .carousel-indicator-fill {
    position: absolute;
    inset: 0;
    background: var(--md-sys-color-primary);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0ms;
  }

  .carousel-indicator.active.animating .carousel-indicator-fill {
    transition: transform var(--animation-duration) linear;
    transform: scaleX(1);
  }

  /* Counter */
  .carousel-counter {
    position: absolute;
    top: 16px;
    right: 16px;
    padding: 8px 16px;
    border-radius: 20px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(12px);
    color: white;
    font: var(--md-sys-typescale-label-medium);
    font-weight: 500;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .carousel-counter-separator {
    margin: 0 4px;
    opacity: 0.7;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .carousel-arrow {
      width: 40px;
      height: 40px;
    }

    .carousel-arrow--prev {
      left: 12px;
    }

    .carousel-arrow--next {
      right: 12px;
    }

    .carousel-caption {
      padding: 16px;
    }

    .carousel-caption-content {
      padding: 12px 16px;
      font: var(--md-sys-typescale-body-medium);
    }

    .carousel-counter {
      top: 12px;
      right: 12px;
      padding: 6px 12px;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .carousel-slide {
      transition-duration: 0ms;
    }

    .carousel-caption-content {
      animation: none;
    }
  }
</style>

<script>
  document.querySelectorAll('.carousel').forEach((carousel) => {
    const carouselEl = carousel as HTMLElement;
    const track = carousel.querySelector('[data-track]') as HTMLElement;
    const slides = carousel.querySelectorAll('.carousel-slide') as NodeListOf<HTMLElement>;
    const indicators = carousel.querySelectorAll('.carousel-indicator');
    const prevBtn = carousel.querySelector('[data-prev]');
    const nextBtn = carousel.querySelector('[data-next]');
    const currentCounter = carousel.querySelector('[data-current]') as HTMLElement;

    const autoplay = carouselEl.dataset.autoplay === 'true';
    const interval = parseInt(carouselEl.dataset.interval || '5000');
    const transition = carouselEl.dataset.transition || 'slide';

    let currentIndex = 0;
    let autoplayInterval: number | null = null;
    let isPaused = false;

    function showSlide(index: number, direction: 'next' | 'prev' = 'next') {
      const prevIndex = currentIndex;

      if (index < 0) index = slides.length - 1;
      if (index >= slides.length) index = 0;

      // Remove classes
      slides.forEach((slide) => {
        slide.classList.remove('active', 'prev');
      });

      // Add classes based on direction
      if (transition === 'slide') {
        if (direction === 'prev') {
          slides[prevIndex].classList.add('active');
          slides[index].classList.add('prev');

          // Force reflow
          void slides[index].offsetWidth;

          slides[prevIndex].classList.remove('active');
          slides[index].classList.remove('prev');
          slides[index].classList.add('active');
        } else {
          slides[index].classList.add('active');
        }
      } else {
        slides[index].classList.add('active');
      }

      // Update indicators
      indicators.forEach((indicator, i) => {
        indicator.classList.toggle('active', i === index);

        // Progress animation for active indicator during autoplay
        if (i === index && autoplay && !isPaused) {
          indicator.classList.add('animating');
          (indicator as HTMLElement).style.setProperty('--animation-duration', `${interval}ms`);
          setTimeout(() => {
            indicator.classList.remove('animating');
          }, interval);
        } else {
          indicator.classList.remove('animating');
        }
      });

      // Update counter
      if (currentCounter) {
        currentCounter.textContent = (index + 1).toString();
      }

      currentIndex = index;
    }

    function nextSlide() {
      showSlide(currentIndex + 1, 'next');
    }

    function prevSlide() {
      showSlide(currentIndex - 1, 'prev');
    }

    function startAutoplay() {
      if (autoplay && !isPaused && slides.length > 1) {
        stopAutoplay();
        autoplayInterval = window.setInterval(nextSlide, interval);

        // Trigger indicator animation
        const activeIndicator = indicators[currentIndex];
        if (activeIndicator) {
          activeIndicator.classList.add('animating');
        }
      }
    }

    function stopAutoplay() {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
        autoplayInterval = null;
      }

      // Stop indicator animations
      indicators.forEach((indicator) => {
        indicator.classList.remove('animating');
      });
    }

    // Navigation buttons
    prevBtn?.addEventListener('click', () => {
      prevSlide();
      stopAutoplay();
      startAutoplay();
    });

    nextBtn?.addEventListener('click', () => {
      nextSlide();
      stopAutoplay();
      startAutoplay();
    });

    // Indicators
    indicators.forEach((indicator, index) => {
      indicator.addEventListener('click', () => {
        const direction = index > currentIndex ? 'next' : 'prev';
        showSlide(index, direction);
        stopAutoplay();
        startAutoplay();
      });
    });

    // Keyboard navigation
    carousel.addEventListener('keydown', ((e: KeyboardEvent) => {
      if (e.key === 'ArrowLeft') {
        prevSlide();
        stopAutoplay();
        startAutoplay();
      }
      if (e.key === 'ArrowRight') {
        nextSlide();
        stopAutoplay();
        startAutoplay();
      }
    }) as EventListener);

    // Pause on hover
    carousel.addEventListener('mouseenter', () => {
      isPaused = true;
      stopAutoplay();
    });

    carousel.addEventListener('mouseleave', () => {
      isPaused = false;
      startAutoplay();
    });

    // Touch swipe
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;

    carousel.addEventListener('touchstart', ((e: TouchEvent) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }) as EventListener);

    carousel.addEventListener('touchmove', ((e: TouchEvent) => {
      touchEndX = e.touches[0].clientX;
      touchEndY = e.touches[0].clientY;
    }) as EventListener);

    carousel.addEventListener('touchend', () => {
      const diffX = touchStartX - touchEndX;
      const diffY = touchStartY - touchEndY;

      // Only trigger if horizontal swipe is dominant
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX > 0) {
          nextSlide();
        } else {
          prevSlide();
        }

        stopAutoplay();
        startAutoplay();
      }
    });

    // Visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopAutoplay();
      } else if (!isPaused) {
        startAutoplay();
      }
    });

    // Start autoplay
    startAutoplay();
  });
</script>
